<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Tic Tac Toe CPU対戦</title>
<style>
body {
    text-align: center;
    font-family: sans-serif;
    background: #222;
    color: #fff;
}
canvas {
    background: #000;
    margin-top: 20px;
    cursor: pointer;
}
button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 1rem;
}
</style>
</head>
<body>
<h1>○×ゲーム</h1>
<canvas id="board" width="300" height="300"></canvas>
<div id="result"></div>
<button id="reset" style="display:none;">もう一度プレイ</button>
<script>
// --- ゲームデータ ---
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');
const resultDiv = document.getElementById('result');
const resetBtn = document.getElementById('reset');

// 0:空, 1:プレイヤー(O), -1:CPU(X)
let board = Array(3).fill(null).map(() => Array(3).fill(0));
let gameOver = false;

// --- 描画関数 ---
function drawBoard() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    // 縦線・横線
    for(let i=1;i<3;i++) {
        ctx.beginPath();
        ctx.moveTo(i*100,0);
        ctx.lineTo(i*100,300);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0,i*100);
        ctx.lineTo(300,i*100);
        ctx.stroke();
    }
    // マーク描画
    for(let y=0;y<3;y++) {
        for(let x=0;x<3;x++) {
            const val = board[y][x];
            if(val === 1) drawO(x,y);
            else if(val === -1) drawX(x,y);
        }
    }
}

function drawO(x,y) {
    ctx.strokeStyle = '#0f0';
    ctx.beginPath();
    ctx.arc(x*100+50,y*100+50,40,0,Math.PI*2);
    ctx.stroke();
}

function drawX(x,y) {
    ctx.strokeStyle = '#f00';
    ctx.beginPath();
    ctx.moveTo(x*100+20,y*100+20);
    ctx.lineTo(x*100+80,y*100+80);
    ctx.moveTo(x*100+80,y*100+20);
    ctx.lineTo(x*100+20,y*100+80);
    ctx.stroke();
}

// --- 勝敗判定 ---
function checkWinner(b) {
    for(let i=0;i<3;i++) {
        const row = b[i][0]+b[i][1]+b[i][2];
        const col = b[0][i]+b[1][i]+b[2][i];
        if(row===3||col===3) return 1;
        if(row===-3||col===-3) return -1;
    }
    const diag1 = b[0][0]+b[1][1]+b[2][2];
    const diag2 = b[0][2]+b[1][1]+b[2][0];
    if(diag1===3||diag2===3) return 1;
    if(diag1===-3||diag2===-3) return -1;
    if(b.flat().every(v=>v!==0)) return 0; // 引き分け
    return null; // 続行
}

// --- ミニマックスでCPU手を計算 ---
function minimax(b, player) {
    const winner = checkWinner(b);
    if(winner!==null) return {score:winner};
    let best;
    if(player===-1) { // CPU: 最大化
        best = {score:-Infinity};
        for(let y=0;y<3;y++) {
            for(let x=0;x<3;x++) {
                if(b[y][x]===0) {
                    b[y][x]=-1;
                    const res = minimax(b,1);
                    b[y][x]=0;
                    if(res.score>best.score) {
                        best={score:res.score,x,y};
                    }
                }
            }
        }
    } else { // プレイヤー: 最小化
        best = {score:Infinity};
        for(let y=0;y<3;y++) {
            for(let x=0;x<3;x++) {
                if(b[y][x]===0) {
                    b[y][x]=1;
                    const res = minimax(b,-1);
                    b[y][x]=0;
                    if(res.score<best.score) {
                        best={score:res.score,x,y};
                    }
                }
            }
        }
    }
    return best;
}

// --- プレイヤーのクリック処理 ---
canvas.addEventListener('click', e => {
    if(gameOver) return;
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX-rect.left)/100);
    const y = Math.floor((e.clientY-rect.top)/100);
    if(board[y][x]!==0) return; // 既に置かれている
    board[y][x]=1; // プレイヤー
    drawBoard();
    endTurn();
    if(!gameOver) cpuMove();
});

// --- CPUの手 ---
function cpuMove() {
    const {x,y} = minimax(board,-1); // 最善手計算
    if(x!==undefined) board[y][x]=-1;
    drawBoard();
    endTurn();
}

// --- ターン終了後の判定 ---
function endTurn() {
    const winner = checkWinner(board);
    if(winner!==null) {
        gameOver=true;
        if(winner===1) resultDiv.textContent='○の勝ち!';
        else if(winner===-1) resultDiv.textContent='×の勝ち!';
        else resultDiv.textContent='引き分け!';
        resetBtn.style.display='inline-block';
    }
}

// --- リセット処理 ---
resetBtn.addEventListener('click', () => {
    board = Array(3).fill(null).map(() => Array(3).fill(0));
    gameOver=false;
    resultDiv.textContent='';
    resetBtn.style.display='none';
    drawBoard();
});

drawBoard();
</script>
</body>
</html>
